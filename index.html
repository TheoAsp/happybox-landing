!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>my Happy Box â€” Kalavryta Edition</title>

<style>
  :root{
    --brand:#ff7a00; --brand-soft:#ffb84d;
    --bg1:#fef9f5; --bg2:#fff6eb; --ink:#333; --muted:#555; --ink2:#222;
    --ok:#1f9d55; --warn:#e2a61f; --err:#d33c3c;
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;
    background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--ink); overflow-x:hidden; }

  .confetti{ position:fixed; inset:0; pointer-events:none; opacity:.18;
    background:
      radial-gradient(circle at 10% 20%, #ff7a00 2px, transparent 3px) 0 0/120px 120px,
      radial-gradient(circle at 80% 30%, #ffb84d 2px, transparent 3px) 0 0/140px 140px,
      radial-gradient(circle at 30% 80%, #ffd699 2px, transparent 3px) 0 0/160px 160px;
    animation: floaty 14s linear infinite; }
  @keyframes floaty{from{transform:translateY(0)}to{transform:translateY(-120px)}}

  header{ text-align:center; padding:56px 20px 24px; animation:drop .8s ease forwards; }
  @keyframes drop{from{opacity:0; transform:translateY(-24px)}to{opacity:1; transform:translateY(0)}}

  .title{ margin:0; font-size:clamp(32px,6vw,56px); color:var(--brand);
    letter-spacing:.4px; display:flex; align-items:center; justify-content:center; gap:.35rem; }
  .title .my{ font-weight:700; font-size:.68em; color:#9a9a9a; margin-right:.15rem }
  .gift{ font-size:.9em; filter:drop-shadow(0 2px 2px rgba(0,0,0,.08)); }
  .edition{ margin:.25rem 0 0; font-size:clamp(14px,2.6vw,20px); color:var(--brand-soft);
    font-style:italic; display:inline-block; transform:rotate(-2deg);
    background:#fff; padding:6px 12px; border:1px dashed #ffd3a1; border-radius:999px; }
  .sub{ margin:14px auto 0; max-width:940px; font-size:clamp(14px,2.1vw,18px);
    color:var(--muted); line-height:1.55; text-align:center; padding:0 16px; }

  .controls{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px }
  .chip{ display:flex; align-items:center; gap:8px; background:#fff; border:1px solid #eee;
    padding:8px 12px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.06); font-size:14px; }
  .chip select{ border:1px solid #e6e6e6; border-radius:10px; padding:6px 10px }
.hero-wrap{ display:flex; justify-content:center; padding:22px 16px 10px; }
  .hero-frame{ width:min(1020px,90vw); height:clamp(260px,48vw,560px);
    background:#fff; border:10px solid #fff; border-radius:18px; box-shadow:0 12px 36px rgba(0,0,0,.14);
    position:relative; overflow:hidden; }
  .hero-img{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain;
    background:#fff; transition:opacity .5s ease; }
  .badge{ position:absolute; top:10px; left:10px; background:rgba(255,255,255,.9);
    color:#444; font-size:12px; padding:4px 8px; border-radius:999px; backdrop-filter:blur(6px); }
  .nav{ position:absolute; top:50%; transform:translateY(-50%); width:42px; height:42px; border-radius:50%;
    background:rgba(255,255,255,.9); display:grid; place-items:center; box-shadow:0 4px 16px rgba(0,0,0,.15);
    cursor:pointer; user-select:none; } .nav:hover{ filter:brightness(1.03) }
  .nav.prev{ left:10px } .nav.next{ right:10px }

  /* animated fox banner (Î¼Î¹ÎºÏÏŒ, Â«Î¶Ï‰Î½Ï„Î±Î½ÏŒÂ» Î±Î»Î»Î¬ Î´Î¹Î±ÎºÏÎ¹Ï„Î¹ÎºÏŒ) */
  .fox-banner{ display:flex; justify-content:center; margin:28px auto 6px; }
  .fox-banner img{ width:240px; height:auto; border-radius:14px;
    animation:bounce 2.8s infinite ease-in-out; box-shadow:0 6px 20px rgba(0,0,0,.08); }
  @keyframes bounce{ 0%,100%{ transform:translateY(0)} 50%{ transform:translateY(-8px)} }

  .quests{ max-width:min(1060px,92vw); margin:32px auto; padding:6px; }
  .card{ background:#fff; border-radius:14px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.08); margin-bottom:14px; }
  .card h3{ margin:4px 0 6px; font-size:20px } .card p{ margin:0 0 12px; color:#666 }
  .row{ display:flex; gap:8px; align-items:center; margin:8px 0; flex-wrap:wrap }
  .row input[type="text"], .row input[type="email"]{ flex:1; min-width:220px; padding:10px 12px; border:1px solid #e6e6e6; border-radius:10px; font-size:15px; }
  .btn{ appearance:none; border:none; cursor:pointer; color:#fff; background:var(--brand);
    padding:10px 14px; border-radius:10px; font-weight:700; box-shadow:0 8px 20px rgba(255,122,0,.3); }
  .btn.alt{ background:#444 } .btn.ghost{ background:#fff; color:#333; border:1px solid #ddd }
  .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:13px; font-weight:600; margin:3px 6px 0 0 }
  .ok{ background:#eaf7f0; color:var(--ok) } .warn{ background:#fff6e0; color:var(--warn) } .err{ background:#fdecec; color:var(--err) }
  .status{ margin-top:6px; font-size:14px; color:#666 }

  .overall{ display:flex; align-items:center; gap:12px; }
  .overall .meter{ flex:1; height:10px; background:#eee; border-radius:999px; overflow:hidden; }
  .overall .meter > span{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#1f9d55,#ff7a00); transition:width .35s ease; }
  .overall .pct{ min-width:42px; font-weight:700; color:#444 }

  .cta{ text-align:center; padding:42px 20px 70px }
  .cta h2{ margin:0 0 10px; font-size:clamp(20px,4vw,28px); color:var(--ink2) }
  .cta p{ margin:0 0 16px; color:#777 }

  footer{ text-align:center; padding:18px; color:#999; font-size:13px }

  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; }
  .modal.show{ display:flex }
  .modal-card{ background:#fff; border-radius:16px; padding:26px 28px; box-shadow:0 20px 60px rgba(0,0,0,.25);
    text-align:center; min-width:min(90vw,520px); }
  .modal-card h3{ margin:0 0 10px }
  .modal-card p{ margin:0 0 10px; color:#555 }
  .modal-card .mini{ font-size:12px; color:#777; margin-top:4px }
  .close{ border:none; background:#eee; border-radius:10px; padding:10px 16px; cursor:pointer; }
  .disabled{ opacity:.55; cursor:not-allowed }

  #victory{ position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.55); z-index:9999; }
  #victory.show{ display:flex; animation:fadeIn .25s ease }
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  .victory-card{ position:relative; text-align:center; background:#fff; border-radius:20px;
    padding:28px 28px 22px; box-shadow:0 24px 80px rgba(0,0,0,.35); overflow:hidden; }
  .victory-card h2{ margin:0 0 6px; font-size:clamp(22px,4vw,32px); color:#222 }
  .victory-card p{ margin:0 0 14px; color:#666 }
  .trophy{ font-size:64px; margin-bottom:8px; animation:pop .5s ease both }
</style>
</head>
<body>
  <div class="confetti" aria-hidden="true"></div>

  <header>
    <h1 class="title"><span class="my">my</span> Happy Box <span class="gift">ğŸ</span></h1>
    <div class="edition" data-i18n="edition">Kalavryta Edition</div>
    <p class="sub" data-i18n="intro">
      A joyful mini-game for travelers! Follow the fox, complete quests around Kalavryta and level-up your reward.  
      Unlock one of <strong>1,000 digital souvenirs in NFT form</strong> â€” the rarer your tier, the rarer your gift. Participation is free! Donâ€™t wait a moment... Have fun, explore, win!
    </p>

    <div class="controls">
      <div class="chip">
        <label for="userEmail" style="font-size:14px;margin-right:6px">Email:</label>
        <input type="email" id="userEmail" placeholder="you@example.com" style="border:1px solid #e6e6e6;border-radius:10px;padding:6px 10px;min-width:220px">
      </div>

      <div class="chip">
        <span data-i18n="lang.label">Language:</span>
        <select id="langSelect" aria-label="Language">
          <option value="en">English</option>
          <option value="el">Î•Î»Î»Î·Î½Î¹ÎºÎ¬</option>
        </select>
      </div>
    </div>
  </header>

  <section class="hero-wrap">
    <div class="hero-frame" id="heroFrame">
      <div class="badge" data-i18n="slider.badge">NFT Preview</div>
      <img id="heroImg" class="hero-img" src="public/photos/2.png" alt="NFT Preview" />
      <div class="nav prev" id="prevBtn" aria-label="Previous">â€¹</div>
      <div class="nav next" id="nextBtn" aria-label="Next">â€º</div>
    </div>
  </section>

  <!-- ÎœÎ¹ÎºÏÏŒ Â«Î¶Ï‰Î½Ï„Î±Î½ÏŒÂ» banner Î¼Îµ Ï„Î·Î½ Î±Î»ÎµÏ€Î¿Ï -->
  <div class="fox-banner">
    <!-- Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ ÎµÎ¯Ï„Îµ Î¼Î¹Î± Î¼Î¹ÎºÏÎ® gif (Ï€.Ï‡. public/photos/fox.gif) ÎµÎ¯Ï„Îµ png (Î¸Î± ÎºÎ¬Î½ÎµÎ¹ bounce animation) -->
    <img src="public/photos/fox.gif" onerror="this.src='public/photos/fox.png'" alt="Happy Fox" />
  </div>

  <section class="quests">
  <!-- ===== Stage 1 ===== -->
    <div class="card" id="s1Card">
      <h3 data-i18n="s1.title">Stage 1 â€” Warm-up (ğŸ¯ complete 3/3)</h3>
      <p data-i18n="s1.desc">You need: 1 social + 1 shop + <strong>1 of the attractions</strong> (extra attractions = bonus).</p>

      <!-- Social -->
      <div class="row"><span data-i18n="social.label">ğŸ“¸ Post with hashtag #myhappybox</span></div>
      <div class="row">
        <input type="text" id="s1PostUrl" placeholder="Public post URL (e.g. Instagram)">
        <button class="btn" id="s1PostBtn" data-i18n="btn.submit">Submit link</button>
      </div>
      <div class="status" id="s1PostStatus"></div>

      <!-- Shop -->
      <div class="row" style="margin-top:10px"><span data-i18n="shops.s1">ğŸª Partner Shop (Stage 1)</span></div>
      <div class="row" style="gap:6px;flex-wrap:wrap">
        <input type="text" id="s1Qr" placeholder="Enter QR code (hidden)">
        <button class="btn" id="s1QrBtn" data-i18n="btn.verify">Verify QR</button>
        <button class="btn ghost" id="s1ScanBtn">ğŸ“· Scan QR</button>
      </div>
      <div class="status" id="s1QrStatus"></div>

      <!-- Attractions -->
      <div class="row" style="margin-top:10px"><span data-i18n="attr.pick">ğŸ—ºï¸ Attractions â€” pick at least one:</span></div>
      <div class="row" id="s1AttrList"></div>
      <div class="row"><button class="btn ghost" id="s1AttrBtn" data-i18n="btn.markVisited">Mark visited</button></div>
      <div class="status" id="s1AttrStatus"></div>
    </div>

    <!-- ===== Stage 2 ===== -->
    <div class="card" id="s2Card">
      <h3 data-i18n="s2.title">Stage 2 â€” Explore more (ğŸ¯ complete 3/3)</h3>
      <p data-i18n="s2.desc">Requires Stage 1 complete. You need: 2 shops + <strong>1 of the attractions</strong> (extras = bonus).</p>

      <!-- Shops -->
      <div class="row"><span data-i18n="shops.s2">ğŸª Partner Shops (Stage 2)</span></div>
      <div class="row" style="gap:6px;flex-wrap:wrap">
        <input type="text" id="s2QrA" placeholder="QR code Shop 2A (hidden)">
        <button class="btn" id="s2QrBtnA">Verify 2A</button>
        <button class="btn ghost" id="s2ScanABtn">ğŸ“· Scan 2A</button>

        <input type="text" id="s2QrB" placeholder="QR code Shop 2B (hidden)">
        <button class="btn" id="s2QrBtnB">Verify 2B</button>
        <button class="btn ghost" id="s2ScanBBtn">ğŸ“· Scan 2B</button>
      </div>
      <div class="status" id="s2QrStatus"></div>

      <!-- Attractions -->
      <div class="row" style="margin-top:10px"><span data-i18n="attr.pick">ğŸ—ºï¸ Attractions â€” pick at least one:</span></div>
      <div class="row" id="s2AttrList" style="gap:14px; align-items:flex-start"></div>
      <div class="row"><button class="btn ghost" id="s2AttrBtn" data-i18n="btn.markVisited">Mark visited</button></div>
      <div class="status" id="s2AttrStatus"></div>
    </div>

    <!-- ===== Stage 3 ===== -->
    <div class="card" id="s3Card">
      <h3 data-i18n="s3.title">Stage 3 â€” The finale (ğŸ¯ complete 4/4)</h3>
      <p data-i18n="s3.desc">Requires Stage 2 complete. You need: 3 shops + <strong>1 of the attractions</strong> (extras = bonus).</p>

      <!-- Shops -->
      <div class="row"><span data-i18n="shops.s3">ğŸª Partner Shops (Stage 3)</span></div>
      <div class="row" style="gap:6px;flex-wrap:wrap">
        <input type="text" id="s3QrA" placeholder="QR for Shop 3A (hidden)">
        <button class="btn" id="s3QrBtnA">Verify 3A</button>
        <button class="btn ghost" id="s3ScanABtn">ğŸ“· Scan 3A</button>

        <input type="text" id="s3QrB" placeholder="QR for Shop 3B (hidden)">
        <button class="btn" id="s3QrBtnB">Verify 3B</button>
        <button class="btn ghost" id="s3ScanBBtn">ğŸ“· Scan 3B</button>

        <input type="text" id="s3QrC" placeholder="QR for Shop 3C (hidden)">
        <button class="btn" id="s3QrBtnC">Verify 3C</button>
        <button class="btn ghost" id="s3ScanCBtn">ğŸ“· Scan 3C</button>
      </div>
      <div class="status" id="s3QrStatus"></div>

      <!-- Attractions -->
      <div class="row" style="margin-top:10px"><span data-i18n="attr.pick">ğŸ—ºï¸ Attractions â€” pick at least one:</span></div>
      <div class="row" id="s3AttrList" style="flex-direction:column; align-items:flex-start"></div>
      <div class="row"><button class="btn ghost" id="s3AttrBtn" data-i18n="btn.markVisited" style="margin-top:6px">Mark visited</button></div>
      <div class="status" id="s3AttrStatus"></div>
    </div>
!-- ===== Progress ===== -->
    <div class="card" id="progressCard">
      <h3 data-i18n="progress.title">Your Progress</h3>

      <div class="overall" style="margin:8px 0 10px; display:flex; align-items:center; gap:12px;">
        <div class="meter" style="flex:1; height:10px; background:#eee; border-radius:999px; overflow:hidden;">
          <span id="overallFill" style="display:block; height:100%; width:0%; background:linear-gradient(90deg,#1f9d55,#ff7a00); transition:width .35s ease;"></span>
        </div>
        <div class="pct" id="overallPct" style="min-width:42px; font-weight:700; color:#444">0%</div>
      </div>

      <div id="progressPills" class="row" style="flex-wrap:wrap"></div>
      <p class="status" id="tierLine">Tier: â€”</p>
      <div class="row">
        <button class="btn alt" id="resetBtn" data-i18n="btn.reset">Reset demo</button>
        <button class="btn" id="claimBtn">ğŸ <span data-i18n="btn.claim">Claim your Happy Box</span></button>
      </div>
      <p class="status" data-i18n="claim.note">
        Claim becomes available once you complete <strong>Stage 1</strong>.
        You can keep playing for rarer tiers!
      </p>
    </div>
  </section>

  <section class="cta">
    <h2 data-i18n="cta.title">Explore â€¢ Play â€¢ Win</h2>
    <p data-i18n="cta.desc">
      Itâ€™s a friendly treasure-hunt across Kalavryta. Finish Stage 1 to unlock Stage 2 and go for rarer rewards!
    </p>
    <button id="mintInfoBtn" class="btn" data-i18n="btn.howClaim">How claiming works</button>
  </section>

  <footer>Â© 2025 Happy Box. All rights reserved.</footer>

  <!-- Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" style="position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50;">
    <div class="modal-card" style="background:#fff; border-radius:16px; padding:26px 28px; box-shadow:0 20px 60px rgba(0,0,0,.25); text-align:center; min-width:min(90vw,520px);">
      <h3 id="modalTitle">Claiming</h3>
      <div id="modalBody"></div>
      <p class="mini" data-i18n="claim.mini" style="font-size:12px; color:#777; margin-top:4px">Your tier is calculated automatically from your completed quests.</p>
      <button class="close" id="closeModal" data-i18n="btn.close" style="border:none; background:#eee; border-radius:10px; padding:10px 16px; cursor:pointer;">Close</button>
    </div>
  </div>

  <!-- Victory overlay -->
  <div id="victory" aria-hidden="true" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:9999;">
    <div class="victory-card" style="position:relative; text-align:center; background:#fff; border-radius:20px; padding:28px 28px 22px; box-shadow:0 24px 80px rgba(0,0,0,.35); overflow:hidden;">
      <div class="confetti-fx" id="confettiFx"></div>
      <div class="trophy" style="font-size:64px; margin-bottom:8px;">ğŸ†</div>
      <h2 data-i18n="victory.title">All quests complete!</h2>
      <p data-i18n="victory.desc">Youâ€™ve reached 100% progress. Time to claim your top reward! ğŸ‰</p>
      <button class="btn" id="victoryClose" data-i18n="btn.awesome">Awesome!</button>
    </div>
  </div>
  !-- ===== Progress ===== -->
    <div class="card" id="progressCard">
      <h3 data-i18n="progress.title">Your Progress</h3>

      <div class="overall" style="margin:8px 0 10px; display:flex; align-items:center; gap:12px;">
        <div class="meter" style="flex:1; height:10px; background:#eee; border-radius:999px; overflow:hidden;">
          <span id="overallFill" style="display:block; height:100%; width:0%; background:linear-gradient(90deg,#1f9d55,#ff7a00); transition:width .35s ease;"></span>
        </div>
        <div class="pct" id="overallPct" style="min-width:42px; font-weight:700; color:#444">0%</div>
      </div>

      <div id="progressPills" class="row" style="flex-wrap:wrap"></div>
      <p class="status" id="tierLine">Tier: â€”</p>
      <div class="row">
        <button class="btn alt" id="resetBtn" data-i18n="btn.reset">Reset demo</button>
        <button class="btn" id="claimBtn">ğŸ <span data-i18n="btn.claim">Claim your Happy Box</span></button>
      </div>
      <p class="status" data-i18n="claim.note">
        Claim becomes available once you complete <strong>Stage 1</strong>.
        You can keep playing for rarer tiers!
      </p>
    </div>
  </section>

  <section class="cta">
    <h2 data-i18n="cta.title">Explore â€¢ Play â€¢ Win</h2>
    <p data-i18n="cta.desc">
      Itâ€™s a friendly treasure-hunt across Kalavryta. Finish Stage 1 to unlock Stage 2 and go for rarer rewards!
    </p>
    <button id="mintInfoBtn" class="btn" data-i18n="btn.howClaim">How claiming works</button>
  </section>

  <footer>Â© 2025 Happy Box. All rights reserved.</footer>

  <!-- Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" style="position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50;">
    <div class="modal-card" style="background:#fff; border-radius:16px; padding:26px 28px; box-shadow:0 20px 60px rgba(0,0,0,.25); text-align:center; min-width:min(90vw,520px);">
      <h3 id="modalTitle">Claiming</h3>
      <div id="modalBody"></div>
      <p class="mini" data-i18n="claim.mini" style="font-size:12px; color:#777; margin-top:4px">Your tier is calculated automatically from your completed quests.</p>
      <button class="close" id="closeModal" data-i18n="btn.close" style="border:none; background:#eee; border-radius:10px; padding:10px 16px; cursor:pointer;">Close</button>
    </div>
  </div>

  <!-- Victory overlay -->
  <div id="victory" aria-hidden="true" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:9999;">
    <div class="victory-card" style="position:relative; text-align:center; background:#fff; border-radius:20px; padding:28px 28px 22px; box-shadow:0 24px 80px rgba(0,0,0,.35); overflow:hidden;">
      <div class="confetti-fx" id="confettiFx"></div>
      <div class="trophy" style="font-size:64px; margin-bottom:8px;">ğŸ†</div>
      <h2 data-i18n="victory.title">All quests complete!</h2>
      <p data-i18n="victory.desc">Youâ€™ve reached 100% progress. Time to claim your top reward! ğŸ‰</p>
      <button class="btn" id="victoryClose" data-i18n="btn.awesome">Awesome!</button>
    </div>
  </div>
!-- Scripts -->
<script type="module">
import QrScanner from "https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js";

/* ========= constants ========= */
const LS_KEY='hb_demo_progress_v5';
const LS_VICTORY='hb_demo_victory_once';
const LS_LANG='hb_demo_lang';
const LS_UID_APP='hb_uid_v1';
const LS_EMAIL_APP='hb_email_v1';

/* ========= UID & Email helpers ========= */
function ensureUid(){
  let uid=localStorage.getItem(LS_UID_APP);
  if(!uid){
    const rnd=(crypto&&crypto.getRandomValues)?crypto.getRandomValues(new Uint8Array(16)):null;
    uid = rnd ? Array.from(rnd).map(x=>x.toString(16).padStart(2,'0')).join('') : String(Date.now())+Math.random().toString(16).slice(2);
    localStorage.setItem(LS_UID_APP,uid);
  }
  return uid;
}
function getEmail(){
  const el=document.getElementById('userEmail');
  return (el&&el.value?el.value:localStorage.getItem(LS_EMAIL_APP)||'').trim().toLowerCase();
}
function setEmail(v){
  localStorage.setItem(LS_EMAIL_APP,(v||'').trim().toLowerCase());
  const el=document.getElementById('userEmail'); if(el) el.value=(v||'');
}
document.addEventListener('DOMContentLoaded',()=>{ 
  const saved=localStorage.getItem(LS_EMAIL_APP)||''; 
  const el=document.getElementById('userEmail'); 
  if(el){ el.value=saved; el.addEventListener('input',()=>setEmail(el.value)); } 
});
const EMAIL_RE=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;

/* ========= i18n ========= */
const T = {
  en:{
    edition:"Kalavryta Edition",
    intro:"A joyful mini-game for travelers! Follow the fox, complete quests around Kalavryta and level-up your reward. Unlock one of <strong>1,000 digital souvenirs in NFT form</strong> â€” the higher your tier, the rarer your gift. Participation is free! Donâ€™t wait a momentâ€¦ Have fun, explore, win!",
    "lang.label":"Language:",
    "slider.badge":"NFT Preview",
    "s1.title":"Stage 1 â€” Warm-up (ğŸ¯ complete 3/3)",
    "s1.desc":"You need: 1 social + 1 shop + <strong>1 of the attractions</strong> (extra attractions = bonus).",
    "s2.title":"Stage 2 â€” Explore more (ğŸ¯ complete 3/3)",
    "s2.desc":"Requires Stage 1 complete. You need: 2 shops + <strong>1 of the attractions</strong> (extras = bonus).",
    "s3.title":"Stage 3 â€” The finale (ğŸ¯ complete 4/4)",
    "s3.desc":"Requires Stage 2 complete. You need: 3 shops + <strong>1 of the attractions</strong> (extras = bonus).",
    "social.label":"ğŸ“¸ Post with hashtag #myhappybox",
    "shops.s1":"ğŸª Partner Shop (Stage 1)",
    "shops.s2":"ğŸª Partner Shops (Stage 2)",
    "shops.s3":"ğŸª Partner Shops (Stage 3)",
    "attr.pick":"ğŸ—ºï¸ Attractions â€” pick at least one:",
    "btn.submit":"Submit link",
    "btn.verify":"Verify QR",
    "btn.markVisited":"Mark visited",
    "btn.verifyBoth":"Verify both",
    "btn.verifyAll":"Verify all",
    "btn.reset":"Reset demo",
    "btn.claim":"Claim your Happy Box",
    "btn.howClaim":"How claiming works",
    "btn.close":"Close",
    "btn.awesome":"Awesome!",
    "progress.title":"Your Progress",
    "claim.note":"Claim becomes available once you complete <strong>Stage 1</strong>. You can keep playing for rarer tiers!",
    "claim.mini":"Your tier is calculated automatically from your completed quests.",
    "victory.title":"All quests complete!",
    "victory.desc":"Youâ€™ve reached 100% progress. Time to claim your top reward! ğŸ‰",
    "cta.title":"Explore â€¢ Play â€¢ Win",
    "cta.desc":"Itâ€™s a friendly treasure-hunt across Kalavryta. Finish Stage 1 to unlock Stage 2 and go for rarer rewards!"
  },
  el:{
    edition:"Kalavryta Edition",
    intro:"ÎˆÎ½Î± Ï‡Î±ÏÎ¿ÏÎ¼ÎµÎ½Î¿ mini-game Î³Î¹Î± Ï„Î±Î¾Î¹Î´Î¹ÏÏ„ÎµÏ‚! Î‘ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎµ Ï„Î·Î½ Î±Î»ÎµÏ€Î¿Ï, ÎºÎ¬Î½Îµ quests ÏƒÏ„Î± ÎšÎ±Î»Î¬Î²ÏÏ…Ï„Î± ÎºÎ±Î¹ Î±Î½Î­Î²Î±ÏƒÎµ Ï„Î¿ reward ÏƒÎ¿Ï…. ÎšÎ»ÎµÎ¯Î´Ï‰ÏƒÎµ Î­Î½Î± Î±Ï€ÏŒ Ï„Î± <strong>1.000 ÏƒÏ…Î»Î»ÎµÎºÏ„Î¹ÎºÎ¬ ÏˆÎ·Ï†Î¹Î±ÎºÎ¬ Î±Î½Î±Î¼Î½Î·ÏƒÏ„Î¹ÎºÎ¬ ÏƒÎµ Î¼Î¿ÏÏ†Î® NFT</strong> â€” ÏŒÏƒÎ¿ Ï€Î¹Î¿ Ï…ÏˆÎ·Î»ÏŒ tier, Ï„ÏŒÏƒÎ¿ Ï€Î¹Î¿ ÏƒÏ€Î¬Î½Î¹Î¿ Ï„Î¿ Î´ÏÏÎ¿ ÏƒÎ¿Ï…. Î— ÏƒÏ…Î¼Î¼ÎµÏ„Î¿Ï‡Î® ÎµÎ¯Î½Î±Î¹ Î´Ï‰ÏÎµÎ¬Î½! ÎœÎ·Î½ Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÎ¹Ï‚ ÏƒÏ„Î¹Î³Î¼Î®â€¦ Î”Î¹Î±ÏƒÎºÎ­Î´Î±ÏƒÎµ, ÎµÎ¾ÎµÏÎµÏÎ½Î·ÏƒÎµ, ÎºÎ­ÏÎ´Î¹ÏƒÎµ!",
    "lang.label":"Î“Î»ÏÏƒÏƒÎ±:",
    "slider.badge":"NFT Preview",
    "s1.title":"Î£Ï„Î¬Î´Î¹Î¿ 1 â€” Î–Î­ÏƒÏ„Î±Î¼Î± (ğŸ¯ 3/3)",
    "s1.desc":"Î§ÏÎµÎ¹Î¬Î¶ÎµÏƒÎ±Î¹: 1 social + 1 ÎºÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î± + <strong>1 Î±Ï€ÏŒ Ï„Î± Î±Î¾Î¹Î¿Î¸Î­Î±Ï„Î±</strong> (Î­Î¾Ï„ÏÎ± Î±Î¾Î¹Î¿Î¸Î­Î±Ï„Î± = bonus).",
    "s2.title":"Î£Ï„Î¬Î´Î¹Î¿ 2 â€” Î ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ· ÎµÎ¾ÎµÏÎµÏÎ½Î·ÏƒÎ· (ğŸ¯ 3/3)",
    "s2.desc":"Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î£Ï„Î±Î´Î¯Î¿Ï… 1. Î˜Î­Î»ÎµÎ¹Ï‚: 2 ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î± + <strong>1 Î±Ï€ÏŒ Ï„Î± Î±Î¾Î¹Î¿Î¸Î­Î±Ï„Î±</strong> (Î­Î¾Ï„ÏÎ± = bonus).",
    "s3.title":"Î£Ï„Î¬Î´Î¹Î¿ 3 â€” Î¤ÎµÎ»Î¹ÎºÏŒÏ‚ (ğŸ¯ 4/4)",
    "s3.desc":"Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î£Ï„Î±Î´Î¯Î¿Ï… 2. Î˜Î­Î»ÎµÎ¹Ï‚: 3 ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î± + <strong>1 Î±Ï€ÏŒ Ï„Î± Î±Î¾Î¹Î¿Î¸Î­Î±Ï„Î±</strong> (Î­Î¾Ï„ÏÎ± = bonus).",
    "social.label":"ğŸ“¸ Î‘Î½Î­Î²Î±ÏƒÎµ post Î¼Îµ #myhappybox",
    "shops.s1":"ğŸª Î£Ï…Î½ÎµÏÎ³Î±Î¶ÏŒÎ¼ÎµÎ½Î¿ ÎºÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î± (Î£Ï„Î¬Î´Î¹Î¿ 1)",
    "shops.s2":"ğŸª Î£Ï…Î½ÎµÏÎ³Î±Î¶ÏŒÎ¼ÎµÎ½Î± ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î± (Î£Ï„Î¬Î´Î¹Î¿ 2)",
    "shops.s3":"ğŸª Î£Ï…Î½ÎµÏÎ³Î±Î¶ÏŒÎ¼ÎµÎ½Î± ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î± (Î£Ï„Î¬Î´Î¹Î¿ 3)",
    "attr.pick":"ğŸ—ºï¸ Î‘Î¾Î¹Î¿Î¸Î­Î±Ï„Î± â€” Î´Î¹Î¬Î»ÎµÎ¾Îµ Ï„Î¿Ï…Î». Î­Î½Î±:",
    "btn.submit":"Î¥Ï€Î¿Î²Î¿Î»Î® link",
    "btn.verify":"ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ QR",
    "btn.markVisited":"Î£Î®Î¼Î±Î½ÏƒÎ· ÎµÏ€Î¯ÏƒÎºÎµÏˆÎ·Ï‚",
    "btn.verifyBoth":"ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÎºÎ±Î¹ Ï„Ï‰Î½ Î´ÏÎ¿",
    "btn.verifyAll":"ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏŒÎ»Ï‰Î½",
    "btn.reset":"Reset demo",
    "btn.claim":"Î Î¬ÏÎµ Ï„Î¿ Happy Box ÏƒÎ¿Ï…",
    "btn.howClaim":"Î ÏÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Ï„Î¿ claim",
    "btn.close":"ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿",
    "btn.awesome":"Î¤Î­Î»ÎµÎ¹Î¿!",
    "progress.title":"Î— Î ÏÏŒÎ¿Î´ÏŒÏ‚ ÏƒÎ¿Ï…",
    "claim.note":"Î¤Î¿ claim ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î¼ÏŒÎ»Î¹Ï‚ Î¿Î»Î¿ÎºÎ»Î·ÏÏÏƒÎµÎ¹Ï‚ Ï„Î¿ <strong>Î£Ï„Î¬Î´Î¹Î¿ 1</strong>. ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÎ¹Ï‚ Î³Î¹Î± ÏƒÏ€Î±Î½Î¹ÏŒÏ„ÎµÏÎ± tiers!",
    "claim.mini":"Î¤Î¿ tier Ï…Ï€Î¿Î»Î¿Î³Î¯Î¶ÎµÏ„Î±Î¹ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± Î±Ï€ÏŒ Ï„Î± quests Ï€Î¿Ï… Î­Ï‡ÎµÎ¹Ï‚ Î¿Î»Î¿ÎºÎ»Î·ÏÏÏƒÎµÎ¹.",
    "victory.title":"ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎµÏ‚ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î­Ï‚!",
    "victory.desc":"ÎˆÏ†Ï„Î±ÏƒÎµÏ‚ 100% Ï€ÏÏŒÎ¿Î´Î¿. ÎÏÎ± Î³Î¹Î± Ï„Î¿ ÎºÎ¿ÏÏ…Ï†Î±Î¯Î¿ reward! ğŸ‰",
    "cta.title":"Explore â€¢ Play â€¢ Win",
    "cta.desc":"ÎˆÎ½Î± Ï†Î¹Î»Î¹ÎºÏŒ ÎºÏ…Î½Î®Î³Î¹ Î¸Î·ÏƒÎ±Ï…ÏÎ¿Ï ÏƒÏ„Î± ÎšÎ±Î»Î¬Î²ÏÏ…Ï„Î±. Î¤ÎµÎ»ÎµÎ¯Ï‰ÏƒÎµ Ï„Î¿ Î£Ï„Î¬Î´Î¹Î¿ 1 Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÎ¹Ï‚ Ï„Î¿ Î£Ï„Î¬Î´Î¹Î¿ 2 ÎºÎ±Î¹ Ï€Î®Î³Î±Î¹Î½Îµ Î³Î¹Î± Ï€Î¹Î¿ ÏƒÏ€Î¬Î½Î¹Î± Î´ÏÏÎ±!"
  }
};
function currentLang(){ return localStorage.getItem(LS_LANG)||'en'; }
function applyLangToDom(){
  const lang=currentLang();
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k=el.getAttribute('data-i18n'); const txt=T[lang][k]; if(txt) el.innerHTML=txt;
  });
  const map = [
    ['s1PostUrl', lang==='el'?"Î”Î·Î¼ÏŒÏƒÎ¹Î¿ link (Ï€.Ï‡. Instagram)":"Public post URL (e.g. Instagram)"],
    ['s1Qr',      lang==='el'?"QR ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ (ÎºÏÏ…Ï†ÏŒ)":"Enter QR code (hidden)"],
    ['s2QrA',     lang==='el'?"QR Î³Î¹Î± ÎšÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î± 2A (ÎºÏÏ…Ï†ÏŒ)":"QR code Shop 2A (hidden)"],
    ['s2QrB',     lang==='el'?"QR Î³Î¹Î± ÎšÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î± 2B (ÎºÏÏ…Ï†ÏŒ)":"QR code Shop 2B (hidden)"],
    ['s3QrA',     lang==='el'?"QR Î³Î¹Î± ÎšÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î± 3A (ÎºÏÏ…Ï†ÏŒ)":"QR for Shop 3A (hidden)"],
    ['s3QrB',     lang==='el'?"QR Î³Î¹Î± ÎšÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î± 3B (ÎºÏÏ…Ï†ÏŒ)":"QR for Shop 3B (hidden)"],
    ['s3QrC',     lang==='el'?"QR Î³Î¹Î± ÎšÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î± 3C (ÎºÏÏ…Ï†ÏŒ)":"QR for Shop 3C (hidden)"],
  ];
  map.forEach(([id,ph])=>{ const el=document.getElementById(id); if(el) el.placeholder=ph; });
}

/* ========= slider ========= */
const slides=Array.from({length:26},(_,i)=>`public/photos/${i+2}.png`);
let sidx=0,timer; 
const heroImg=document.getElementById('heroImg'), frame=document.getElementById('heroFrame');
function show(n){ sidx=(n+slides.length)%slides.length; if(!heroImg) return;
  heroImg.style.opacity=0; 
  setTimeout(()=>{ heroImg.src=slides[sidx]; heroImg.onload=()=>heroImg.style.opacity=1; },180); 
}
function start(){ timer=setInterval(()=>show(sidx+1),4000) } 
function stop(){ clearInterval(timer) }
document.getElementById('prevBtn')?.addEventListener('click',()=>{stop();show(sidx-1);start()});
document.getElementById('nextBtn')?.addEventListener('click',()=>{stop();show(sidx+1);start()});
if(frame){ frame.onmouseenter=stop; frame.onmouseleave=start; show(0); start(); }

/* ========= attractions & layout ========= */
const ATTR = {
  museum:{en:"Municipal Museum of the Kalavryta Holocaust ğŸ›ï¸", el:"Î”Î·Î¼Î¿Ï„Î¹ÎºÏŒ ÎœÎ¿Ï…ÏƒÎµÎ¯Î¿ ÎšÎ±Î»Î±Î²ÏÏ…Ï„Î¹Î½Î¿Ï ÎŸÎ»Î¿ÎºÎ±Ï…Ï„ÏÎ¼Î±Ï„Î¿Ï‚ ğŸ›ï¸", checkpoint:"museum"},
  agialavra:{en:"Monastery of Agia Lavra â›ª", el:"ÎœÎ¿Î½Î® Î‘Î³Î¯Î±Ï‚ Î›Î±ÏÏÎ±Ï‚ â›ª", checkpoint:"agiaLavra"},
  square:{en:"Petmezai Square ğŸï¸", el:"Î Î»Î±Ï„ÎµÎ¯Î± Î ÎµÏ„Î¼ÎµÎ¶Î±Î¯Ï‰Î½ ğŸï¸", checkpoint:"petmezaionSquare"},
  hill:{en:"Place of Sacrifice / Hill of Kapi â›°ï¸", el:"Î¤ÏŒÏ€Î¿Ï‚ Î˜Ï…ÏƒÎ¯Î±Ï‚ / Î›ÏŒÏ†Î¿Ï‚ Ï„Î¿Ï… ÎšÎ±Ï€Î¯ â›°ï¸", checkpoint:"kapi"},
  heroes:{en:"Heroes of 1821 Monument ğŸ—¿", el:"ÎœÎ½Î·Î¼ÎµÎ¯Î¿ Î—ÏÏÏ‰Î½ Î‘Î³Ï‰Î½Î¹ÏƒÏ„ÏÎ½ Ï„Î¿Ï… 1821 ğŸ—¿", checkpoint:"heroes1821"},
  ski:{en:"Kalavryta Ski Center ğŸ¿", el:"Î§Î¹Î¿Î½Î¿Î´ÏÎ¿Î¼Î¹ÎºÏŒ ÎºÎ­Î½Ï„ÏÎ¿ ÎšÎ±Î»Î±Î²ÏÏÏ„Ï‰Î½ ğŸ¿", checkpoint:"skiCenter"},
  odontotos:{en:"Odontotos Rack Railway ğŸš†", el:"ÎŸÎ´Î¿Î½Ï„Ï‰Ï„ÏŒÏ‚ ğŸš†", checkpoint:"vouraikosGorge"},
  cave:{en:"Cave of Lakes ğŸ•³ï¸", el:"Î£Ï€Î®Î»Î±Î¹Î¿ Ï„Ï‰Î½ Î›Î¹Î¼Î½ÏÎ½ ğŸ•³ï¸", checkpoint:"caveOfLakes"},
  gorge:{en:"Vouraikos Gorge ğŸï¸", el:"Î¦Î±ÏÎ¬Î³Î³Î¹ Ï„Î¿Ï… Î’Î¿Ï…ÏÎ±ÏŠÎºÎ¿Ï ğŸï¸", checkpoint:"vouraikosGorge"},
  makellaria:{en:"Holy Monastery of Makellaria â›ª", el:"Î™ÎµÏÎ¬ ÎœÎ¿Î½Î® ÎœÎ±ÎºÎµÎ»Î»Î±ÏÎ¹Î¬Ï‚ â›ª", checkpoint:"moniMakellarias"},
  tower:{en:"Petmezai Tower ğŸ°", el:"Î ÏÏÎ³Î¿Ï‚ Î ÎµÏ„Î¼ÎµÎ¶Î±Î¯Ï‰Î½ ğŸ°", checkpoint:"pyrgosPetmezaion"}
};
const LAYOUTS = { s1:['museum','agialavra','square'], s2:['hill','heroes','odontotos','ski'], s3:['gorge','cave','makellaria','tower'] };
const s1AttrList=document.getElementById('s1AttrList');
const s2AttrList=document.getElementById('s2AttrList');
const s3AttrList=document.getElementById('s3AttrList');
function makeAttrRow(stageKey, key, label){
  const wrap=document.createElement('div');
  wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='8px'; wrap.style.flexWrap='wrap';
  const lab=document.createElement('label'); lab.style.display='flex'; lab.style.alignItems='center'; lab.style.gap='6px';
  const cb=document.createElement('input'); cb.type='checkbox'; cb.id=`${stageKey}_${key}`;
  lab.appendChild(cb); lab.appendChild(document.createTextNode(' '+label));
  wrap.appendChild(lab);
  const btn=document.createElement('button'); btn.className='btn ghost'; btn.textContent='ğŸ“ Verify by location';
  btn.addEventListener('click', ()=> verifyAttractionByGeo(stageKey, key));
  wrap.appendChild(btn);
  return wrap;
}
function renderAttractions(){
  const lang=currentLang();
  if(s1AttrList){ s1AttrList.innerHTML=''; LAYOUTS.s1.forEach(k=> s1AttrList.appendChild(makeAttrRow('s1', k, ATTR[k][lang]))); }
  if(s2AttrList){ s2AttrList.innerHTML=''; LAYOUTS.s2.forEach(k=> s2AttrList.appendChild(makeAttrRow('s2', k, ATTR[k][lang]))); }
  if(s3AttrList){ s3AttrList.innerHTML=''; LAYOUTS.s3.forEach(k=> s3AttrList.appendChild(makeAttrRow('s3', k, ATTR[k][lang]))); }
}

/* ========= local store & progress ========= */
function loadStore(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||'{}')}catch{return{}} }
function saveStore(o){ localStorage.setItem(LS_KEY, JSON.stringify(o||{})) }
function clearStore(){ localStorage.removeItem(LS_KEY); localStorage.removeItem(LS_VICTORY); }
function addDone(key){ const s=loadStore(); s.completed=Array.from(new Set([...(s.completed||[]), key])); saveStore(s); }

const pills=document.getElementById('progressPills'), tierLine=document.getElementById('tierLine');
const overallFill=document.getElementById('overallFill'), overallPct=document.getElementById('overallPct');
function getState(){
  const done=new Set((loadStore().completed)||[]);
  const s1Attrs=LAYOUTS.s1.map(k=>'s1:attr:'+k);
  const s1={ post:done.has('s1:post'), shop:done.has('s1:shop'), attrOk:s1Attrs.some(k=>done.has(k)) };
  const s1ok=s1.post&&s1.shop&&s1.attrOk;
  const s2Attrs=LAYOUTS.s2.map(k=>'s2:attr:'+k);
  const s2={ shopA:done.has('s2:shopA'), shopB:done.has('s2:shopB'), attrOk:s1ok&&s2Attrs.some(k=>done.has(k)) };
  const s2ok=s1ok&&s2.shopA&&s2.shopB&&s2.attrOk;
  const s3Attrs=LAYOUTS.s3.map(k=>'s3:attr:'+k);
  const s3={ shopA:done.has('s3:shopA'), shopB:done.has('s3:shopB'), shopC:done.has('s3:shopC'), attrOk:s2ok&&s3Attrs.some(k=>done.has(k)) };
  const s3ok=s2ok&&s3.shopA&&s3.shopB&&s3.shopC&&s3.attrOk;
  const overallCount=(s1.post?1:0)+(s1.shop?1:0)+(s1.attrOk?1:0)+
                     (s2.shopA?1:0)+(s2.shopB?1:0)+(s2.attrOk?1:0)+
                     (s3.shopA?1:0)+(s3.shopB?1:0)+(s3.shopC?1:0)+(s3.attrOk?1:0);
  const tier = s3ok ? 'Legendary'
             : s2ok ? 'Rare â†’ Ultra Rare'
             : s1ok ? 'Common â†’ Uncommon'
             : 'â€”';
  return {done, s1ok, s2ok, s3ok, overallCount, tier};
}
function pill(text){ const el=document.createElement('span'); el.className='pill ok'; el.textContent=text; return el; }
function render(){
  const st=getState();
  const s2Card=document.getElementById('s2Card'); if(s2Card) s2Card.style.display = st.s1ok ? '' : 'none';
  const s3Card=document.getElementById('s3Card'); if(s3Card) s3Card.style.display = st.s2ok ? '' : 'none';
  if(pills){ pills.innerHTML=''; st.done && st.done.forEach?.(k=>pills.appendChild(pill(k))); }
  const pct=Math.round(st.overallCount/10*100);
  if(overallFill) overallFill.style.width=pct+'%'; 
  if(overallPct) overallPct.textContent=pct+'%';
  if(tierLine) tierLine.textContent='Tier: '+st.tier;
  if(pct===100) triggerVictoryOnce();
}

/* ========= Social verify (API) ========= */
async function verifySocial(url, statusEl, questKey){
  const lang=currentLang();
  if(!/^https?:\/\//i.test(url)){ 
    statusEl.innerHTML = lang==='el' ? '<span class="pill err">Î’Î¬Î»Îµ Î­Î³ÎºÏ…ÏÎ¿ link</span>' : '<span class="pill err">Paste a valid public URL</span>'; 
    return;
  }
  statusEl.textContent = lang==='el' ? 'ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚â€¦' : 'Checkingâ€¦';
  try{
    const resp = await fetch('/api/verify-social',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ url, hashtag:'#myhappybox' })
    });
    const data = await resp.json().catch(()=>({}));
    if(!resp.ok || !data?.ok){
      statusEl.innerHTML = lang==='el' ? '<span class="pill err">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ #myhappybox</span>' : '<span class="pill err">#myhappybox not found</span>';
      return;
    }
    addDone(questKey);
    statusEl.innerHTML = '<span class="pill ok">Verified</span>';
    render();
  }catch{
    statusEl.innerHTML = '<span class="pill err">Server error</span>';
  }
}

/* ========= QR verify (STRICT, masked) ========= */
function maskInput(el){ if(!el) return; el.type='password'; el.value='â€¢â€¢â€¢â€¢'; el.setAttribute('autocomplete','off'); el.setAttribute('readonly','readonly'); setTimeout(()=>el.blur(),0); }
function setCode(el, code){ if(!el) return; el.dataset.code=code; maskInput(el); }
function getCode(el){ return el?.dataset?.code?.trim() || ''; }
function setStatus(el, html){ if(el) el.innerHTML = html; }

async function verifyQR(questId, inputEl, statusEl){
  const uid=ensureUid(); const email=getEmail();
  if(!EMAIL_RE.test(email||'')){ return setStatus(statusEl,'<span class="pill err">Î’Î¬Î»Îµ Î­Î³ÎºÏ…ÏÎ¿ email</span>'); }
  const code = getCode(inputEl);
  if(!code){ return setStatus(statusEl,'<span class="pill err">Î£ÎºÎ¬Î½Î±ÏÎµ Ï„Î¿ QR</span>'); }
  setStatus(statusEl,'Î•Ï€Î±Î»Î®Î¸ÎµÏ…ÏƒÎ·â€¦');
  try{
    const r=await fetch('/api/verify-qr',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({uid,email,code,questId})});
    const data=await r.json().catch(()=>({}));
    if(!r.ok){
      if(data?.error==='already used') setStatus(statusEl,'<span class="pill warn">Î‰Î´Î· Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎµ Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ email</span>');
      else if(data?.error==='invalid code') setStatus(statusEl,'<span class="pill err">Î›Î¬Î¸Î¿Ï‚ QR code</span>');
      else if(data?.error==='wrong code for this quest') setStatus(statusEl,'<span class="pill err">Î›Î¬Î¸Î¿Ï‚ QR Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ ÏƒÏ„Î¬Î´Î¹Î¿</span>');
      else setStatus(statusEl,`<span class="pill err">${data.error||('HTTP '+r.status)}</span>`);
      return;
    }
    setStatus(statusEl,'<span class="pill ok">QR verified âœ…</span>');
    addDone(questId); 
    if(inputEl){ inputEl.dataset.code=''; inputEl.value=''; inputEl.type='password'; }
    render();
  }catch{ setStatus(statusEl,'<span class="pill err">Î”Î¯ÎºÏ„Ï…Î¿/Server error</span>'); }
}

/* ========= QR CAMERA ========= */
async function scanInto(inputEl){
  const overlay=document.createElement('div');
  overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='rgba(0,0,0,.7)';
  overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.zIndex='9999';
  const box=document.createElement('div'); box.style.background='#000'; box.style.borderRadius='12px'; box.style.padding='8px';
  const video=document.createElement('video'); video.style.width='min(92vw,520px)'; video.style.height='auto'; video.playsInline=true;
  const close=document.createElement('button'); close.textContent='Close'; close.className='btn'; close.style.marginTop='8px';
  box.appendChild(video); box.appendChild(close); overlay.appendChild(box); document.body.appendChild(overlay);

  const scanner=new QrScanner(video, result=>{
    const code=(result?.data||result||'').trim();
    setCode(inputEl, code);
    scanner.stop(); overlay.remove();
  }, { returnDetailedScanResult:true, highlightScanRegion:true, highlightCodeOutline:true });

  await scanner.start();
  close.onclick=()=>{ scanner.stop(); overlay.remove(); };
}

/* ========= GEOLOCATION for attractions ========= */
async function verifyAttractionByGeo(stageKey, key){
  const statusEl = document.getElementById(stageKey==='s1'?'s1AttrStatus':stageKey==='s2'?'s2AttrStatus':'s3AttrStatus');
  const uid=ensureUid(); const questId=`${stageKey}:attr:${key}`;
  if(!navigator.geolocation){ return setStatus(statusEl,'<span class="pill err">Geolocation not supported</span>'); }
  setStatus(statusEl,'Checking locationâ€¦');
  navigator.geolocation.getCurrentPosition(async pos=>{
    try{
      const body={ uid, lat:pos.coords.latitude, lon:pos.coords.longitude, checkpoint:ATTR[key].checkpoint, questId };
      const r=await fetch('/api/geo-check',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const data=await r.json().catch(()=>({}));
      if(!r.ok){ setStatus(statusEl,`<span class="pill err">${data.error||('HTTP '+r.status)}</span>`); return; }
      if(data.ok){
        addDone(questId);
        const cb=document.getElementById(`${stageKey}_${key}`); if(cb) cb.checked=true;
        setStatus(statusEl,'<span class="pill ok">Location verified âœ…</span>');
        render();
      }else{
        const km=(data.distance/1000).toFixed(2);
        setStatus(statusEl,`<span class="pill warn">Too far (~${km} km)</span>`);
      }
    }catch{ setStatus(statusEl,'<span class="pill err">Server error</span>'); }
  }, err=> setStatus(statusEl, `<span class="pill err">${err.message}</span>`), {enableHighAccuracy:true,timeout:15000});
}

/* ========= interactions ========= */
document.getElementById('langSelect')?.addEventListener('change',(e)=>{ localStorage.setItem(LS_LANG, e.target.value); renderAll(); });

// Social (Stage 1 â€” Î¯Î´Î¹Î± Î»Î¿Î³Î¹ÎºÎ® Î³Î¹Î± ÏŒÏ€Î¿Î¹Î¿ Î¬Î»Î»Î¿ stage Î¶Î·Ï„Î®ÏƒÎµÎ¹Ï‚)
document.getElementById('s1PostBtn')?.addEventListener('click',()=>{
  const url=document.getElementById('s1PostUrl')?.value.trim();
  const stS=document.getElementById('s1PostStatus');
  if(!stS) return;
  verifySocial(url, stS, 's1:post');
});

// QR buttons (ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ ÎºÏÏ…Ï†ÏŒÏ‚, Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ scan)
document.getElementById('s1ScanBtn')?.addEventListener('click',()=> scanInto(document.getElementById('s1Qr')));
document.getElementById('s1QrBtn')?.addEventListener('click',()=> verifyQR('s1:shop', document.getElementById('s1Qr'), document.getElementById('s1QrStatus')));

document.getElementById('s2ScanABtn')?.addEventListener('click',()=> scanInto(document.getElementById('s2QrA')));
document.getElementById('s2QrBtnA')?.addEventListener('click',()=> verifyQR('s2:shopA', document.getElementById('s2QrA'), document.getElementById('s2QrStatus')));
document.getElementById('s2ScanBBtn')?.addEventListener('click',()=> scanInto(document.getElementById('s2QrB')));
document.getElementById('s2QrBtnB')?.addEventListener('click',()=> verifyQR('s2:shopB', document.getElementById('s2QrB'), document.getElementById('s2QrStatus')));

document.getElementById('s3ScanABtn')?.addEventListener('click',()=> scanInto(document.getElementById('s3QrA')));
document.getElementById('s3QrBtnA')?.addEventListener('click',()=> verifyQR('s3:shopA', document.getElementById('s3QrA'), document.getElementById('s3QrStatus')));
document.getElementById('s3ScanBBtn')?.addEventListener('click',()=> scanInto
                                             
</script>
</body>
</html>
