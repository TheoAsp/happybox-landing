<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>my Happy Box ‚Äî Kalavryta Edition</title>
<style>
  :root{
    --brand:#ff7a00; --brand-soft:#ffb84d; --bg1:#fef9f5; --bg2:#fff6eb;
    --ink:#333; --muted:#555; --card:#fff; --ok:#1a7f37; --warn:#b54708;
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
        background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--ink); overflow-x:hidden; }
  .confetti{ position:fixed; inset:0; pointer-events:none; opacity:.18;
    background:
      radial-gradient(circle at 10% 20%, #ff7a00 2px, transparent 3px) 0 0/120px 120px,
      radial-gradient(circle at 80% 30%, #ffb84d 2px, transparent 3px) 0 0/140px 140px,
      radial-gradient(circle at 30% 80%, #ffd699 2px, transparent 3px) 0 0/160px 160px;
    animation: floaty 14s linear infinite; }
  @keyframes floaty{from{transform:translateY(0)}to{transform:translateY(-120px)}}
  header{ text-align:center; padding:56px 20px 16px; }
  .title{ margin:0; font-size:clamp(32px,6vw,56px); letter-spacing:.4px; color:var(--brand); display:flex; gap:.5rem; justify-content:center; align-items:center;}
  .mytag{ font-size:.6em; background:#222; color:#fff; border-radius:999px; padding:.1em .55em; opacity:.9 }
  .gift{ filter:drop-shadow(0 2px 2px rgba(0,0,0,.08)); }
  .edition{ margin:.25rem 0 0; font-size:clamp(14px,2.5vw,20px); color:var(--brand-soft); font-style:italic; display:inline-block;
    transform:rotate(-2deg); background:#fff; padding:6px 12px; border:1px dashed var(--brand-soft); border-radius:999px; }
  .sub{ margin:14px auto 0; max-width:940px; font-size:clamp(14px,2.1vw,18px); color:var(--muted); line-height:1.55; padding:0 16px; text-align:center; }

  .hero-wrap{display:flex; justify-content:center; padding:22px 16px 10px;}
  .hero{ width:min(1020px,90vw); background:#fff; border-radius:18px; border:10px solid #fff; box-shadow:0 12px 36px rgba(0,0,0,.14); }
  .hero > img{ width:100%; height:clamp(260px,48vw,560px); object-fit:contain; background:#fff; display:block; }

  .cta{ text-align:center; padding:18px 16px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap }
  .btn{ appearance:none; border:none; cursor:pointer; color:#fff; background:var(--brand);
        padding:14px 18px; border-radius:12px; font-size:16px; font-weight:700; box-shadow:0 8px 20px rgba(255,122,0,.35);}
  .btn.secondary{ background:#222 }
  .btn:disabled{ opacity:.6; cursor:not-allowed }

  .panel{ max-width:min(1020px,92vw); margin:14px auto 28px; background:var(--card); border-radius:16px; padding:16px;
          box-shadow:0 8px 26px rgba(0,0,0,.08); }
  .panel h3{ margin:0 0 8px }
  .grid{ display:grid; grid-template-columns: 1fr; gap:10px }
  @media (min-width:720px){ .grid{ grid-template-columns: 1fr 1fr } }
  .quest{ border:1px solid #eee; border-radius:12px; padding:12px 14px }
  .quest h4{ margin:0 0 8px }
  .steps{ margin:0; padding-left:18px }
  .steps li{ margin:4px 0 }
  .tag{ font-size:12px; border-radius:999px; padding:2px 8px; background:#eee; display:inline-block; margin-left:6px }
  .ok{ color:var(--ok); font-weight:700 }
  .warn{ color:var(--warn); font-weight:700 }

  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:#111; color:#fff; padding:10px 14px; border-radius:10px; display:none }
  .toast.show{ display:block }
  footer{ text-align:center; padding:22px; color:#999; font-size:13px }
</style>
</head>
<body>
<div class="confetti" aria-hidden="true"></div>

<header>
  <h1 class="title"><span class="mytag">my</span> Happy Box <span class="gift">üéÅ</span></h1>
  <div class="edition">Kalavryta Edition</div>
  <p class="sub">
    Unlock your gift: <strong>one of 100 limited-edition NFT photos of Kalavryta</strong>.  
    Complete quests around town to upgrade your reward‚Äîno spoilers, only surprise!
  </p>
</header>

<section class="hero-wrap">
  <div class="hero">
    <img id="heroImg" src="public/photos/7.png" alt="Kalavryta preview"/>
  </div>
</section>

<section class="cta">
  <button id="mintPass" class="btn">üéÅ Mint Quest Pass (check-in)</button>
  <button id="mintReward" class="btn secondary">üèÅ Mint Reward (check-out)</button>
</section>

<section class="panel">
  <h3>Progress</h3>
  <div class="grid">
    <div class="quest">
      <h4>Quest 1 <span class="tag">2 tasks</span></h4>
      <ol class="steps">
        <li>Scan QR in <strong>Main Square</strong> <span id="q1s1"></span></li>
        <li>Scan QR in <strong>Holocaust Museum</strong> <span id="q1s2"></span></li>
      </ol>
      <button class="btn" id="geoPlatia">üìç I‚Äôm at the square</button>
    </div>
    <div class="quest">
      <h4>Quest 2 <span class="tag">3 tasks</span></h4>
      <ol class="steps">
        <li>Scan a QR in <strong>Shop X</strong> <span id="q2s1"></span></li>
        <li>Scan a QR in <strong>Shop Y</strong> <span id="q2s2"></span></li>
        <li>Scan QR at <strong>Hill of Kapi</strong> <span id="q2s3"></span></li>
      </ol>
      <button class="btn" id="geoKapi">üìç I‚Äôm at Hill of Kapi</button>
    </div>
  </div>
</section>

<section class="panel">
  <h3>Bundle example</h3>
  <img src="public/photos/1.png" alt="Bundle example" style="width:100%;max-width:1020px;display:block;border-radius:12px;border:10px solid #fff;box-shadow:0 8px 26px rgba(0,0,0,.08);" />
</section>

<footer>¬© 2025 Happy Box. All rights reserved.</footer>

<div id="toast" class="toast"></div>

<script>
  // ======== Config (frontend) ========
  const API = {
    progress: "/api/progress",
    verifyQR: "/api/verify-qr",
    geoCheck: "/api/geo-check",
    award: "/api/award",
  };

  // very light "auth": ask email once, keep in localStorage (swap later with Paper Auth)
  function getUserEmail(){
    let email = localStorage.getItem("hb_email");
    if(!email){
      email = prompt("Enter your email to track progress (you can mint with this email later):") || "";
      email = email.trim();
      if(!email) return null;
      localStorage.setItem("hb_email", email);
    }
    return email;
  }

  function toast(msg, ok=true){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.style.background = ok ? "#111" : "#b54708";
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2500);
  }

  // ======== Progress UI ========
  function setFlag(el, done){ el.textContent = done ? "‚úì" : "‚Ä¢"; el.className = done ? "ok" : "warn"; }
  async function refreshProgress(){
    const email = getUserEmail(); if(!email) return;
    const res = await fetch(API.progress + "?email=" + encodeURIComponent(email));
    const data = await res.json();

    const p = data.progress || {};
    setFlag(document.getElementById("q1s1"), !!p.q1?.s1);
    setFlag(document.getElementById("q1s2"), !!p.q1?.s2);
    setFlag(document.getElementById("q2s1"), !!p.q2?.s1);
    setFlag(document.getElementById("q2s2"), !!p.q2?.s2);
    setFlag(document.getElementById("q2s3"), !!p.q2?.s3);
  }

  // ======== Handle QR token in URL (?c=...) ========
  async function handleQRFromURL(){
    const u = new URL(location.href);
    const token = u.searchParams.get("c");
    if(!token) return;
    const email = getUserEmail(); if(!email) return;

    const res = await fetch(API.verifyQR + "?c=" + encodeURIComponent(token) + "&email=" + encodeURIComponent(email));
    const data = await res.json();
    if(data.ok){ toast("Checkpoint recorded!"); await refreshProgress(); }
    else { toast("Invalid/expired QR.", false); }
    // clean URL
    u.searchParams.delete("c");
    history.replaceState({}, "", u.pathname + (u.searchParams.toString()?("?"+u.searchParams.toString()):""));
  }

  // ======== Geofence helpers (optional v1) ========
  async function geoCheck(place){
    const email = getUserEmail(); if(!email) return;
    if(!("geolocation" in navigator)){ toast("Geolocation not available", false); return; }
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      const payload = {
        email,
        place,
        lat: pos.coords.latitude,
        lon: pos.coords.longitude
      };
      const res = await fetch(API.geoCheck, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
      const data = await res.json();
      if(data.ok){ toast("Location verified! Check the QR at this spot to complete the step."); refreshProgress(); }
      else { toast(data.error || "Out of range.", false); }
    }, ()=>toast("Location permission denied", false), {enableHighAccuracy:true, timeout:10000});
  }

  document.getElementById("geoPlatia").addEventListener("click", ()=>geoCheck("platia"));
  document.getElementById("geoKapi").addEventListener("click", ()=>geoCheck("kapi"));

  // ======== Mint buttons ========
  document.getElementById("mintPass").addEventListener("click", async ()=>{
    const email = getUserEmail(); if(!email) return;
    // For v1 just show a message; wire to Paper/thirdweb in /api/award when you want.
    const res = await fetch(API.award + "?email=" + encodeURIComponent(email) + "&type=pass");
    const data = await res.json();
    if(data.ok){
      if(data.claimUrl){ location.href = data.claimUrl; }
      else toast("Pass ready (integration stub).");
    } else toast("Mint failed.", false);
  });

  document.getElementById("mintReward").addEventListener("click", async ()=>{
    const email = getUserEmail(); if(!email) return;
    const res = await fetch(API.award + "?email=" + encodeURIComponent(email) + "&type=reward");
    const data = await res.json();
    if(data.ok){
      if(data.claimUrl){ location.href = data.claimUrl; }
      else toast("Reward ready (integration stub).");
    } else toast(data.error || "Not eligible yet.", false);
  });

  // init
  refreshProgress();
  handleQRFromURL();
</script>
</body>
</html>
