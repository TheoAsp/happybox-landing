<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>my Happy Box ‚Äî Kalavryta Edition</title>

<style>
  :root{
    --brand:#ff7a00; --brand-soft:#ffb84d;
    --bg1:#fef9f5; --bg2:#fff6eb; --ink:#333; --muted:#555; --ink2:#222;
    --ok:#1f9d55; --warn:#e2a61f; --err:#d33c3c;
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;
    background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--ink); overflow-x:hidden; }

  /* confetti bg */
  .confetti{ position:fixed; inset:0; pointer-events:none; opacity:.18;
    background:
      radial-gradient(circle at 10% 20%, #ff7a00 2px, transparent 3px) 0 0/120px 120px,
      radial-gradient(circle at 80% 30%, #ffb84d 2px, transparent 3px) 0 0/140px 140px,
      radial-gradient(circle at 30% 80%, #ffd699 2px, transparent 3px) 0 0/160px 160px;
    animation: floaty 14s linear infinite; }
  @keyframes floaty{from{transform:translateY(0)}to{transform:translateY(-120px)}}

  header{ text-align:center; padding:56px 20px 24px; animation:drop .8s ease forwards; }
  @keyframes drop{from{opacity:0; transform:translateY(-24px)}to{opacity:1; transform:translateY(0)}}

  .title{ margin:0; font-size:clamp(32px,6vw,56px); color:var(--brand);
    letter-spacing:.4px; display:flex; align-items:center; justify-content:center; gap:.35rem; }
  .title .my{ font-weight:700; font-size:.68em; color:#9a9a9a; margin-right:.15rem }
  .gift{ font-size:.9em; filter:drop-shadow(0 2px 2px rgba(0,0,0,.08)); }
  .edition{ margin:.25rem 0 0; font-size:clamp(14px,2.6vw,20px); color:var(--brand-soft);
    font-style:italic; display:inline-block; transform:rotate(-2deg);
    background:#fff; padding:6px 12px; border:1px dashed var(--brand-soft); border-radius:999px; }
  .sub{ margin:14px auto 0; max-width:940px; font-size:clamp(14px,2.1vw,18px);
    color:var(--muted); line-height:1.55; text-align:center; padding:0 16px; }

  /* Slider */
  .hero-wrap{ display:flex; justify-content:center; padding:22px 16px 10px; }
  .hero-frame{ width:min(1020px,90vw); height:clamp(260px,48vw,560px);
    background:#fff; border:10px solid #fff; border-radius:18px; box-shadow:0 12px 36px rgba(0,0,0,.14);
    position:relative; overflow:hidden; }
  .hero-img{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain;
    background:#fff; transition:opacity .5s ease; }
  .badge{ position:absolute; top:10px; left:10px; background:rgba(255,255,255,.9);
    color:#444; font-size:12px; padding:4px 8px; border-radius:999px; backdrop-filter:blur(6px); }
  .nav{ position:absolute; top:50%; transform:translateY(-50%); width:42px; height:42px; border-radius:50%;
    background:rgba(255,255,255,.9); display:grid; place-items:center; box-shadow:0 4px 16px rgba(0,0,0,.15);
    cursor:pointer; user-select:none; } .nav:hover{ filter:brightness(1.03) }
  .nav.prev{ left:10px } .nav.next{ right:10px }

  /* Example */
  .example{ max-width:min(1020px,90vw); margin:26px auto 0; padding:18px 14px 8px;
    border-radius:18px; background:rgba(255,255,255,.65); box-shadow:0 8px 26px rgba(0,0,0,.08); }
  .example h4{ margin:0 0 10px 6px; font-size:13px; color:#666; font-weight:600; }
  .example-img{ display:block; width:100%; height:auto; border-radius:12px;
    background:#fff; border:10px solid #fff; box-shadow:0 8px 26px rgba(0,0,0,.08); }

  /* Quests */
  .quests{ max-width:min(1060px,92vw); margin:32px auto; padding:6px; }
  .card{ background:#fff; border-radius:14px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.08); margin-bottom:14px; }
  .card h3{ margin:4px 0 6px; font-size:20px } .card p{ margin:0 0 12px; color:#666 }
  .row{ display:flex; gap:8px; align-items:center; margin:8px 0; flex-wrap:wrap }
  .row input[type="text"]{ flex:1; min-width:260px; padding:10px 12px; border:1px solid #e6e6e6; border-radius:10px; font-size:15px; }
  .btn{ appearance:none; border:none; cursor:pointer; color:#fff; background:var(--brand);
    padding:10px 14px; border-radius:10px; font-weight:700; box-shadow:0 8px 20px rgba(255,122,0,.3); }
  .btn.alt{ background:#444 } .btn.ghost{ background:#fff; color:#333; border:1px solid #ddd }
  .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:13px; font-weight:600; margin:3px 6px 0 0 }
  .ok{ background:#eaf7f0; color:var(--ok) } .warn{ background:#fff6e0; color:var(--warn) } .err{ background:#fdecec; color:var(--err) }
  .status{ margin-top:6px; font-size:14px; color:#666 }

  /* Stage tracker */
  .stage{ display:flex; align-items:center; gap:12px; margin:10px 0 6px }
  .step{ display:flex; align-items:center; gap:8px; color:#666; }
  .dot{ width:22px; height:22px; border-radius:50%; border:2px solid #ddd; display:grid; place-items:center; font-size:12px; background:#fff }
  .step.done .dot{ border-color:var(--ok); background:#eaf7f0; color:var(--ok) }
  .bar{ flex:1; height:4px; background:#eee; border-radius:999px; position:relative; overflow:hidden }
  .bar > span{ position:absolute; inset:0 0 0 auto; width:0%; background:linear-gradient(90deg,#27c498,#ffb84d); transition:width .4s ease }
  .sublabel{ font-size:12px; color:#888 }

  /* Overall progress bar */
  .overall{ display:flex; align-items:center; gap:12px; }
  .overall .meter{ flex:1; height:10px; background:#eee; border-radius:999px; overflow:hidden; }
  .overall .meter > span{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#1f9d55,#ff7a00); transition:width .35s ease; }
  .overall .pct{ min-width:42px; font-weight:700; color:#444 }

  /* CTA */
  .cta{ text-align:center; padding:42px 20px 70px }
  .cta h2{ margin:0 0 10px; font-size:clamp(20px,4vw,28px); color:var(--ink2) }
  .cta p{ margin:0 0 16px; color:#muted }

  footer{ text-align:center; padding:18px; color:#999; font-size:13px }

  /* Modal */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; }
  .modal.show{ display:flex }
  .modal-card{ background:#fff; border-radius:16px; padding:26px 28px; box-shadow:0 20px 60px rgba(0,0,0,.25);
    text-align:center; min-width:min(90vw,520px); }
  .modal-card h3{ margin:0 0 10px }
  .modal-card p{ margin:0 0 10px; color:#555 }
  .modal-card .mini{ font-size:12px; color:#777; margin-top:4px }
  .close{ border:none; background:#eee; border-radius:10px; padding:10px 16px; cursor:pointer; }
  .disabled{ opacity:.55; cursor:not-allowed }

  /* Victory overlay */
  #victory{ position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.55); z-index:9999; }
  #victory.show{ display:flex; animation:fadeIn .25s ease }
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  .victory-card{ position:relative; text-align:center; background:#fff; border-radius:20px;
    padding:28px 28px 22px; box-shadow:0 24px 80px rgba(0,0,0,.35); overflow:hidden; }
  .victory-card h2{ margin:0 0 6px; font-size:clamp(22px,4vw,32px); color:#222 }
  .victory-card p{ margin:0 0 14px; color:#666 }
  .trophy{ font-size:64px; margin-bottom:8px; animation:pop .5s ease both }
  @keyframes pop{ from{ transform:scale(.7); opacity:.2 } to{ transform:scale(1); opacity:1 } }
  .confetti-fx{ position:absolute; inset:-20px; pointer-events:none }
  .piece{ position:absolute; width:10px; height:14px; border-radius:2px; opacity:.9;
    animation:fall 1.2s linear forwards, spin 1.2s linear forwards; }
  @keyframes fall{ from{ transform:translateY(-40vh) } to{ transform:translateY(60vh) } }
  @keyframes spin{ from{ transform:rotate(0) } to{ transform:rotate(720deg) } }
</style>
</head>
<body>
  <div class="confetti" aria-hidden="true"></div>

  <header>
    <h1 class="title"><span class="my">my</span> Happy Box <span class="gift">üéÅ</span></h1>
    <div class="edition">Kalavryta Edition</div>
    <p class="sub">
      A joyful mini-game for travelers! Complete quests around Kalavryta to level-up your reward.  
      Unlock one of <strong>1,000 limited-edition NFT photos</strong> ‚Äî the rarer your tier, the rarer your art.
      Have fun, explore, win surprises!
    </p>
  </header>

  <!-- Slider -->
  <section class="hero-wrap">
    <div class="hero-frame" id="heroFrame">
      <div class="badge">Kalavryta preview</div>
      <img id="heroImg" class="hero-img" src="public/photos/2.png" alt="Kalavryta preview" />
      <div class="nav prev" id="prevBtn" aria-label="Previous">‚Äπ</div>
      <div class="nav next" id="nextBtn" aria-label="Next">‚Ä∫</div>
    </div>
  </section>

  <!-- Bundle example -->
  <section class="example">
    <h4>Bundle example</h4>
    <img class="example-img" src="public/photos/1.png" alt="Bundle Minted example" />
  </section>

  <!-- ===== GAME / QUESTS ===== -->
  <section class="quests">
    <!-- Stage tracker -->
    <div class="card" id="stageCard">
      <h3>Stage <span id="stageNum">1</span> ‚Äî Play to unlock the next!</h3>
      <div class="stage">
        <div class="step" id="stStep1"><div class="dot">1</div><div>Stage 1</div></div>
        <div class="bar"><span id="barFill"></span></div>
        <div class="step" id="stStep2"><div class="dot">2</div><div>Stage 2</div></div>
        <div class="bar" style="max-width:120px"><span></span></div>
        <div class="step" id="stStep3"><div class="dot">3</div><div>Stage 3</div></div>
      </div>
      <div class="sublabel" id="stageHint">Finish Stage 1 to unlock Stage 2 ‚Äî and aim for rarer tiers.</div>
    </div>

    <!-- Stage 1 card -->
    <div class="card" id="s1Card">
      <h3>Stage 1 ‚Äî Warm-up (üéØ complete 3/3)</h3>
      <p>You need: 1 social + 1 shop + <strong>1 of the attractions</strong> (extra attractions = bonus).</p>

      <!-- Social -->
      <div class="row"><span>üì∏ Post with hashtag #myhappybox</span></div>
      <div class="row">
        <input type="text" id="s1PostUrl" placeholder="Public post URL (e.g. Instagram)">
        <button class="btn" id="s1PostBtn">Submit link</button>
      </div>
      <div class="status" id="s1PostStatus"></div>

      <!-- Shop (1) -->
      <div class="row" style="margin-top:10px"><span>üè™ Partner Shop (Stage 1)</span></div>
      <div class="row">
        <input type="text" id="s1Qr" placeholder="Enter QR code (placeholder)">
        <button class="btn" id="s1QrBtn">Verify QR</button>
      </div>
      <div class="status" id="s1QrStatus"></div>

      <!-- Attractions (choose ‚â•1) -->
      <div class="row" style="margin-top:10px"><span>üó∫Ô∏è Attractions ‚Äî pick at least one:</span></div>
      <div class="row">
        <label><input type="checkbox" id="s1A_museum"> ŒîŒ∑ŒºŒøœÑŒπŒ∫œå ŒúŒøœÖœÉŒµŒØŒø ŒöŒ±ŒªŒ±Œ≤œÅœÖœÑŒπŒΩŒøœç ŒüŒªŒøŒ∫Œ±œÖœÑœéŒºŒ±œÑŒøœÇ üèõÔ∏è</label>
        <label><input type="checkbox" id="s1A_agialavra"> ŒúŒøŒΩŒÆ ŒëŒ≥ŒØŒ±œÇ ŒõŒ±œçœÅŒ±œÇ ‚õ™</label>
        <label><input type="checkbox" id="s1A_square"> Œ†ŒªŒ±œÑŒµŒØŒ± Œ†ŒµœÑŒºŒµŒ∂Œ±ŒØœâŒΩ üèûÔ∏è</label>
        <button class="btn ghost" id="s1AttrBtn">Mark visited</button>
      </div>
      <div class="status" id="s1AttrStatus"></div>
    </div>

    <!-- Stage 2 card -->
    <div class="card" id="s2Card">
      <h3>Stage 2 ‚Äî Explore more (üéØ complete 3/3)</h3>
      <p>Requires Stage 1 complete. You need: 2 shops + <strong>1 of the attractions</strong> (extras = bonus).</p>

      <!-- Shops (2) -->
      <div class="row"><span>üè™ Partner Shops (Stage 2)</span></div>
      <div class="row">
        <input type="text" id="s2QrA" placeholder="Enter QR code for Shop 2A">
        <input type="text" id="s2QrB" placeholder="Enter QR code for Shop 2B">
        <button class="btn" id="s2QrBtn">Verify both</button>
      </div>
      <div class="status" id="s2QrStatus"></div>

      <!-- Attractions (choose ‚â•1) -->
      <div class="row" style="margin-top:10px"><span>üß≠ Attractions ‚Äî pick at least one:</span></div>
      <div class="row" style="gap:14px; align-items:flex-start">
        <div style="display:flex; flex-direction:column; gap:6px">
          <label><input type="checkbox" id="s2A_hill"> Œ§œåœÄŒøœÇ ŒòœÖœÉŒØŒ±œÇ / ŒõœåœÜŒøœÇ œÑŒøœÖ ŒöŒ±œÄŒπ ‚õ∞Ô∏è</label>
          <button class="btn" id="s2GeoBtn">Verify my location</button>
        </div>
        <div style="display:flex; flex-direction:column; gap:6px; flex:1">
          <label><input type="checkbox" id="s2A_odontotos"> Odontotos Rack Railway üöÜ</label>
          <div class="row">
            <input type="text" id="s2RailUrl" placeholder="Public photo URL with #myhappybox">
            <button class="btn ghost" id="s2RailBtn">Submit URL</button>
          </div>
        </div>
        <div style="display:flex; flex-direction:column; gap:6px">
          <label><input type="checkbox" id="s2A_heroes"> ŒúŒΩŒ∑ŒºŒµŒØŒø ŒóœÅœéœâŒΩ ŒëŒ≥œâŒΩŒπœÉœÑœéŒΩ œÑŒøœÖ 1821 üóø</label>
          <button class="btn ghost" id="s2MarkBtn">Mark visited</button>
        </div>
      </div>
      <div class="status" id="s2AttrStatus"></div>
    </div>

    <!-- Stage 3 card -->
    <div class="card" id="s3Card">
      <h3>Stage 3 ‚Äî The finale (üéØ complete 4/4)</h3>
      <p>Requires Stage 2 complete. You need: 3 shops + <strong>1 of the attractions</strong> (extras = bonus).</p>

      <!-- Shops (3) -->
      <div class="row"><span>üè™ Partner Shops (Stage 3)</span></div>
      <div class="row">
        <input type="text" id="s3QrA" placeholder="QR for Shop 3A">
        <input type="text" id="s3QrB" placeholder="QR for Shop 3B">
        <input type="text" id="s3QrC" placeholder="QR for Shop 3C">
        <button class="btn" id="s3QrBtn">Verify all</button>
      </div>
      <div class="status" id="s3QrStatus"></div>

      <!-- Attractions (choose ‚â•1) -->
      <div class="row" style="margin-top:10px"><span>üó∫Ô∏è Attractions ‚Äî pick at least one:</span></div>
      <div class="row" style="flex-direction:column; align-items:flex-start">
        <label><input type="checkbox" id="s3A_cave"> Œ£œÄŒÆŒªŒ±ŒπŒø œÑœâŒΩ ŒõŒπŒºŒΩœéŒΩ üï≥Ô∏è</label>
        <label><input type="checkbox" id="s3A_gorge"> Œ¶Œ±œÅŒ¨Œ≥Œ≥Œπ œÑŒøœÖ ŒíŒøœÖœÅŒ±œäŒ∫Œøœç üèûÔ∏è</label>
        <label><input type="checkbox" id="s3A_ski"> ŒßŒπŒøŒΩŒøŒ¥œÅŒøŒºŒπŒ∫œå Œ∫Œ≠ŒΩœÑœÅŒø ŒöŒ±ŒªŒ±Œ≤œÅœçœÑœâŒΩ üéø</label>
        <label><input type="checkbox" id="s3A_makellaria"> ŒôŒµœÅŒ¨ ŒúŒøŒΩŒÆ ŒúŒ±Œ∫ŒµŒªŒªŒ±œÅŒπŒ¨œÇ ‚õ™</label>
        <label><input type="checkbox" id="s3A_tower"> Œ†œçœÅŒ≥ŒøœÇ Œ†ŒµœÑŒºŒµŒ∂Œ±ŒØœâŒΩ üè∞</label>
        <button class="btn ghost" id="s3AttrBtn" style="margin-top:6px">Mark visited</button>
      </div>
      <div class="status" id="s3AttrStatus"></div>
    </div>

    <!-- Progress & Tier -->
    <div class="card" id="progressCard">
      <h3>Your Progress</h3>

      <!-- Overall progress bar -->
      <div class="overall" style="margin:8px 0 10px">
        <div class="meter"><span id="overallFill"></span></div>
        <div class="pct" id="overallPct">0%</div>
      </div>

      <div id="progressPills" class="row" style="flex-wrap:wrap"></div>
      <p class="status" id="tierLine">Tier: ‚Äî</p>
      <div class="row">
        <button class="btn alt" id="resetBtn">Reset demo</button>
        <button class="btn" id="claimBtn">üéÅ Claim your Happy Box</button>
      </div>
      <p class="status">Claim becomes available once you complete <strong>Stage 1</strong>. You can keep playing for rarer tiers!</p>
    </div>
  </section>

  <section class="cta">
    <h2>Explore ‚Ä¢ Play ‚Ä¢ Win</h2>
    <p>It‚Äôs a friendly treasure-hunt across Kalavryta. Finish Stage 1 to unlock Stage 2 and go for rarer rewards!</p>
    <button id="mintInfoBtn" class="btn">How claiming works</button>
  </section>

  <footer>¬© 2025 Happy Box. All rights reserved.</footer>

  <!-- Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-card">
      <h3 id="modalTitle">Claiming</h3>
      <div id="modalBody"></div>
      <p class="mini">Your tier is calculated automatically from your completed quests.</p>
      <button class="close" id="closeModal">Close</button>
    </div>
  </div>

  <!-- Victory overlay -->
  <div id="victory" aria-hidden="true">
    <div class="victory-card">
      <div class="confetti-fx" id="confettiFx"></div>
      <div class="trophy">üèÜ</div>
      <h2>All quests complete!</h2>
      <p>You‚Äôve reached 100% progress. Time to claim your top reward! üéâ</p>
      <button class="btn" id="victoryClose">Awesome!</button>
    </div>
  </div>

<script>
/* ========= helpers & store ========= */
const LS_KEY='hb_demo_progress_v3';
const LS_VICTORY='hb_demo_victory_once';
function loadStore(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||'{}')}catch(e){return{}} }
function saveStore(o){ localStorage.setItem(LS_KEY, JSON.stringify(o||{})) }
function clearStore(){ localStorage.removeItem(LS_KEY); localStorage.removeItem(LS_VICTORY); }
function addDone(key){ const s=loadStore(); s.completed=Array.from(new Set([...(s.completed||[]), key])); saveStore(s); }

/* ========= slider (2..27) ========= */
const slides=Array.from({length:26},(_,i)=>`public/photos/${i+2}.png`);
let s=0,timer; const heroImg=document.getElementById('heroImg'), frame=document.getElementById('heroFrame');
function show(n){ s=(n+slides.length)%slides.length; heroImg.style.opacity=0;
  setTimeout(()=>{ heroImg.src=slides[s]; heroImg.onload=()=>heroImg.style.opacity=1; },180); }
function start(){ timer=setInterval(()=>show(s+1),4000) } function stop(){ clearInterval(timer) }
document.getElementById('prevBtn').onclick=()=>{stop();show(s-1);start()};
document.getElementById('nextBtn').onclick=()=>{stop();show(s+1);start()};
frame.onmouseenter=stop; frame.onmouseleave=start; show(0); start();

/* ========= state model =========
 Stage 1 (need 3): s1:post, s1:shop, any(s1 attractions*)
 Stage 2 (need 3): s2:shopA, s2:shopB, any(s2 attractions*)
 Stage 3 (need 4): s3:shopA, s3:shopB, s3:shopC, any(s3 attractions*)
 Overall minimal = 10
================================= */
function getState(){
  const done=new Set((loadStore().completed)||[]);
  // S1 attractions
  const s1Attr = {
    museum: done.has('s1:attr:museum'),
    agialavra: done.has('s1:attr:agialavra'),
    square: done.has('s1:attr:square'),
  };
  const s1 = {
    post: done.has('s1:post'),
    shop: done.has('s1:shop'),
    attrOk: (s1Attr.museum || s1Attr.agialavra || s1Attr.square)
  };
  const s1ok = s1.post && s1.shop && s1.attrOk;

  // S2 attractions
  const s2Attr = {
    hill: done.has('s2:attr:hill'),
    odontotos: done.has('s2:attr:odontotos'),
    heroes: done.has('s2:attr:heroes'),
  };
  const s2 = {
    shopA: done.has('s2:shopA'),
    shopB: done.has('s2:shopB'),
    attrOk: (s2Attr.hill || s2Attr.odontotos || s2Attr.heroes)
  };
  const s2ok = s1ok && s2.shopA && s2.shopB && s2.attrOk;

  // S3 attractions
  const s3Attr = {
    cave: done.has('s3:attr:cave'),
    gorge: done.has('s3:attr:gorge'),
    ski: done.has('s3:attr:ski'),
    makellaria: done.has('s3:attr:makellaria'),
    tower: done.has('s3:attr:tower'),
  };
  const s3 = {
    shopA: done.has('s3:shopA'),
    shopB: done.has('s3:shopB'),
    shopC: done.has('s3:shopC'),
    attrOk: (s3Attr.cave || s3Attr.gorge || s3Attr.ski || s3Attr.makellaria || s3Attr.tower)
  };
  const s3ok = s2ok && s3.shopA && s3.shopB && s3.shopC && s3.attrOk;

  // minimal required for 100%
  const overallCount =
    (s1.post?1:0)+(s1.shop?1:0)+(s1.attrOk?1:0)+
    (s2.shopA?1:0)+(s2.shopB?1:0)+(s2.attrOk?1:0)+
    (s3.shopA?1:0)+(s3.shopB?1:0)+(s3.shopC?1:0)+(s3.attrOk?1:0);

  let stage=1; if(s1ok) stage=2; if(s2ok) stage=3; if(s3ok) stage=3;

  // Tier hint (extras help IRL)
  const tier = s3ok ? 'Legendary'
            : s2ok ? 'Rare ‚Üí Ultra Rare'
            : s1ok ? 'Common ‚Üí Uncommon'
            : '‚Äî';

  return {done, s1, s2, s3, s1ok, s2ok, s3ok, stage, overallCount, tier,
          s1Attr, s2Attr, s3Attr};
}

/* ========= render UI ========= */
const st1El=document.getElementById('stStep1'), st2El=document.getElementById('stStep2'), st3El=document.getElementById('stStep3');
const barFill=document.getElementById('barFill'), stageNum=document.getElementById('stageNum'), stageHint=document.getElementById('stageHint');
const
